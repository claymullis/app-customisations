#!/bin/bash

set -e

name="$1"
version="$2"
cmd="$3"
USAGE="USAGE: `basename $0` package-name version"
if [ -z "$name" -o -z "$version" ]; then
	set +x
	echo "$USAGE"
	exit 1
fi
feed="$name.xml"
base="http://gfxmonk.net/dist/0install"
webdest="$HOME/Sites/gfxmonk/dist/0install"
archive_base="$base/$name"
build=0inst

if [ "$version" = "date" ]; then
	version=`date "+%Y%m%d.%H%M"`
	echo "version: $version"
	cp "$build/$name.tgz" "$build/$name-$version.tgz"
fi

set -x
if [ "$cmd" != "copy" ]; then
	0publish "$feed" \
		--set-interface-uri="$base"/"$feed"
	if fgrep "$version" "$feed" | fgrep 'archive'; then
		echo "need a new version?"; sleep 2;
		0publish "$feed" \
			--set-version="$version" \
			--set-released=today
	else
		0publish "$feed" \
			--add-version="$version" \
			--archive-url="$archive_base/$name-$version.tgz" \
			--archive-file="$build/$name-$version.tgz" \
			--set-released=today
	fi
fi

mkdir -p "$webdest/$name"
cp "$feed" "$webdest/"
cp "$build/$name-$version.tgz" "$webdest/$name/"
0publish "$webdest/$feed" --xmlsign

(cd $HOME/Sites/gfxmonk && rsync -r --delete dist _site/)
echo "make sure to upload!"
